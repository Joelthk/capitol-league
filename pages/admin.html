<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Capitol League â€“ Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      background: #2b2b2b;
      color: #f2f2f2;
      font-family: Arial, sans-serif;
      padding: 2rem;
    }

    h1, h2 {
      margin-bottom: 0.5rem;
    }

    .box {
      background: #3a3a3a;
      padding: 1.5rem;
      border-radius: 8px;
      max-width: 500px;
      margin-bottom: 2rem;
    }

    input, select, button {
      width: 100%;
      padding: 0.6rem;
      margin-top: 0.5rem;
      font-size: 1rem;
    }

    button {
      background: #c2a26b;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }

    button:hover {
      background: #d4b57f;
    }

    .hidden {
      display: none;
    }

    .error {
      color: #ff6b6b;
      margin-top: 0.5rem;
    }

    .success {
      color: #7bed9f;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>

  <h1>Capitol League â€” Admin Panel</h1>

  <!-- ADMIN KEY LOGIN -->
  <div id="admin-login" class="box">
    <h2>Admin Access</h2>
    <input type="password" id="adminKeyInput" placeholder="Enter admin key" />
    <button onclick="unlockAdmin()">Unlock Admin</button>
    <div id="loginMessage" class="error"></div>
  </div>

  <!-- UPDATE CONSOLE -->
  <div id="admin-console" class="box hidden">
    <h2>Daily Update Console</h2>

    <label>Update Window</label>
    <select id="updateWindow">
      <option value="09:00">9:00 AM</option>
      <option value="17:00">5:00 PM</option>
    </select>

    <label>Politician</label>
    <select id="politicianSelect"></select>

    <label>Percent Change</label>
    <input type="number" step="0.01" id="percentChange" placeholder="e.g. 0.33 or -0.45" />

    <button onclick="submitUpdate()">Confirm Update</button>
    <div id="updateMessage" class="success"></div>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, getDocs, addDoc, serverTimestamp } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ðŸ”´ REPLACE WITH YOUR FIREBASE CONFIG
    const firebaseConfig = {
  apiKey: "AIzaSyCjotIoBJtRrp3p3q6s9TSdZ044pAQoB20",
  authDomain: "capitol-league.firebaseapp.com",
  projectId: "capitol-league",
  storageBucket: "capitol-league.firebasestorage.app",
  messagingSenderId: "243628029572",
  appId: "1:243628029572:web:216113ddf24fba4ceab4d1"
  };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const adminLogin = document.getElementById("admin-login");
    const adminConsole = document.getElementById("admin-console");
    const loginMessage = document.getElementById("loginMessage");
    const updateMessage = document.getElementById("updateMessage");

    // Load politicians into dropdown
    // async function loadPoliticians() {
    //   const snap = await getDocs(collection(db, "politicians"));
    //   const select = document.getElementById("politicianSelect");
    //   select.innerHTML = "";

    //   snap.forEach(doc => {
    //     const opt = document.createElement("option");
    //     opt.value = doc.id;
    //     opt.textContent = doc.data().name;
    //     select.appendChild(opt);
    //   });
    // }

    async function loadPoliticians() {
  console.log("Loading politiciansâ€¦");

  const snap = await getDocs(collection(db, "Politicians")); // or whatever casing you chose

  console.log("Docs found:", snap.size);

  const select = document.getElementById("politicianSelect");
  select.innerHTML = "";

  snap.forEach(docSnap => {
    console.log("Doc ID:", docSnap.id, "Data:", docSnap.data());

    const data = docSnap.data();

    const opt = document.createElement("option");
    opt.value = docSnap.id;
    opt.textContent = data.name || "(NO NAME FIELD)";
    select.appendChild(opt);
  });
}


    // ADMIN UNLOCK
    window.unlockAdmin = async function () {
      const enteredKey = document.getElementById("adminKeyInput").value;

      const adminDoc = await getDoc(doc(db, "admin", "config"));

      if (!adminDoc.exists()) {
        loginMessage.textContent = "Admin config not found.";
        return;
      }

      const realKey = adminDoc.data().adminKey;

      if (enteredKey === realKey) {
        sessionStorage.setItem("isAdmin", "true");
        adminLogin.classList.add("hidden");
        adminConsole.classList.remove("hidden");
        loginMessage.textContent = "";
        await loadPoliticians();
      } else {
        loginMessage.textContent = "Invalid admin key.";
      }
    };

    // SUBMIT UPDATE
    window.submitUpdate = async function () {
      const politicianId = document.getElementById("politicianSelect").value;
      const percentChange = parseFloat(document.getElementById("percentChange").value);
      const updateWindow = document.getElementById("updateWindow").value;

      if (isNaN(percentChange)) {
        updateMessage.textContent = "Enter a valid percentage.";
        return;
      }

      await addDoc(collection(db, "Snapshots"), {
        politicianId,
        percentChange,
        updateWindow,
        timestamp: serverTimestamp()
      });

      updateMessage.textContent = "Update recorded successfully.";
      document.getElementById("percentChange").value = "";
    };

    // AUTO-UNLOCK IF SESSION EXISTS
    if (sessionStorage.getItem("isAdmin") === "true") {
      adminLogin.classList.add("hidden");
      adminConsole.classList.remove("hidden");
      loadPoliticians();
    }
  </script>

</body>
</html>

